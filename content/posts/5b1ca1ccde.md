+++
title = """helmã¨helm templateã«ã¤ã„ã¦ã®æ°—ã¥ã ç¬¬äºŒå› yqã‚’ä½¿ã£ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®åˆ†å‰²"""
date = 2025-04-28T01:36:20.000Z
expiryDate = 2025-07-07T09:08:20.822Z
tags = ["vtj","devops"]
+++
ã•ã¦ã„ã‚ˆã„ã‚ˆæœ¬é¡Œã«å…¥ã‚‹ã®ã§ã™ãŒã€ã“ã®ä½œæˆã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€è¤‡æ•°ã®YAMLå½¢å¼ã§æ›¸ã‹ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãŒåˆä½“ã—ã¦ã„ã‚‹ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚

$ helm template mywordpress ./wordpress -f ./values.yaml > mywp-manifests.yaml 

ã‚‚ã®ã™ã”ãé•·ã„ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã£ã¦ãŠã‚Šã€å¯èª­æ€§ã¯è‰¯ããªã„ã§ã™ã‚ˆã­ã€‚ å¹¸ã„ã«ã‚‚ã“ã®æ–¹æ³•ã§ç”Ÿæˆã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯`---`åŒºåˆ‡ã‚Šã§ãã‚Œãã‚Œè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ã“ã®è¾ºã‚Šã§åˆ‡ã‚Šé›¢ã›ã°è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã§ããã†ã§ã™ã€‚ æ—©é€ŸChatGPTã‚„Google Geminiã«ãã®æ–¹æ³•ã‚’èã„ã¦ã¿ã¾ã—ãŸã€‚ ãŠãŠã‚ˆãã©ã¡ã‚‰ã‚‚åŒã˜ã‚ˆã†ãªå›ç­”ã ã£ãŸã®ã§ã€ä»¥ä¸‹ã¯ChatGPTã‚’ä½¿ã£ãŸå ´åˆã§èª¬æ˜ã—ã¾ã™ã€‚

ã¾ãšã€ChatGPTã¯äºŒã¤ã®æ–¹æ³•ã‚’æç¤ºã—ã¾ã—ãŸã€‚ ä¸€ã¤ã¯csplitã‚’ä½¿ã†æ–¹æ³•ã€‚Windowsã®å ´åˆã¯WSLãªã©ã§ç’°å¢ƒã‚’æ•´ãˆã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã™ãŒã€Linuxã‚„macOSã§ã¯æ¨™æº–ã§ä½¿ãˆã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ ã‚‚ã†ä¸€ã¤ã¯yqã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚jqã¯Jsonã«ä½¿ã†ã®ã«å¯¾ã—ã€yqã¯YAMLã«ä½¿ã†ã¿ãŸã„ãªã‚‚ã®ã§ã™ã€‚

yqã¯ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã€yqã‚’ä½¿ã£ã¦è©¦ãã†ã¨ã—ã¾ã—ãŸã€‚ ã¨ã“ã‚ãŒã†ã¾ãã„ãã¾ã›ã‚“ã€‚

$ pipx install yq
$ yq eval-all 'splitDoc' mywp-manifests.yaml  \\
  | awk 'BEGIN{n=0;}{if(/^---/){n++} print > sprintf("manifest\_%03d.yaml", n)}'
yq: error: argument files: can't open 'splitDoc': \[Errno 2\] No such file or directory: 'splitDoc'

ãã“ã§å†åº¦ChatGPTã«èã„ã¦ã¿ã‚‹ã¨ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯yqã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³4ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚Pythonã®yqãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³3ã®å®Ÿè£…ã®ã‚‚ã®ãŒæä¾›ã•ã‚Œã‚‹ã‚‰ã—ãã€ãã¡ã‚‰ãŒå¿…è¦ã ã¨ã€‚

*   [https://github.com/mikefarah/yq/](https://github.com/mikefarah/yq/)

macOSã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€æ¬¡ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³3ã®yqã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³4ã®yqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªãŠã—ã¾ã—ãŸã€‚

$ pipx install yq
$ brew install yq

ä»Šåº¦ã¯ã‚³ãƒãƒ³ãƒ‰ãŒé€šã£ãŸã®ã§ã™ãŒä½•ã‹ãŒãŠã‹ã—ã„ã§ã™ã€‚ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹ã¤ãã‚‰ã‚Œãªã„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã€‚

$ yq eval 'splitDoc' mywp-manifests.yaml  \\
  | awk 'BEGIN{n=0;}{if(/^---/){n++} print > sprintf("manifest\_%03d.yaml", n)}'

ã€Œãªã‚“ã§ï¼Ÿã€ã¨èã„ãŸã¨ã“ã‚æ¬¡ã®ã‚ˆã†ãªå›ç­”ã‚’ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

ãªã‚‹ã»ã©ã€è©³ã—ãèª¬æ˜ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼macOSã§ yq eval 'splitDoc' ã‚’ä½¿ã£ã¦ã‚‚1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã‹ãªã‚‰ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚
å®Ÿã¯ã€ã“ã“ã§ã¡ã‚‡ã£ã¨ã—ãŸ ç†è§£ã®ã‚ºãƒ¬ ãŒã‚ã‚Šã¾ã—ãŸ ğŸ™‡â€â™‚ï¸
yq eval 'splitDoc' ã¯ æ¨™æº–å‡ºåŠ›ä¸Šã§å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ --- ã§åŒºåˆ‡ã£ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ ã§ã€è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«è‡ªå‹•ã§åˆ†å‰²ã™ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã†æ–¹æ³•ã¨ã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§æ¸ˆã¾ã™æ–¹æ³•ãŒæç¤ºã•ã‚ŒãŸãŸã‚ã€ä»Šå›ã¯ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã®æ–¹ã‚’å®Ÿè¡Œã—ã¦ã€ã“ã¨ãªãã‚’å¾—ã¾ã—ãŸã€‚

$ yq eval '... comments=""' mywp-manifests.yaml  | \\
awk '/^---/ {n++} {print > sprintf("manifest\_%03d.yaml", n)}'

é•·ããªã£ãŸã®ã§ã€æ¬¡å›ã«ç¶šãã¾ã™ã€‚

ç¬¬3å›ã«ç¶šã

[devops-blog.virtualtech.jp](https://devops-blog.virtualtech.jp/entry/20250430/1745979859)

[[source]](https://devops-blog.virtualtech.jp/entry/20250428/1745804180)
